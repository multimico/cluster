#cloud-config
autoinstall:
  version: 1

  refresh-installer:
    update: yes

  apt:
    geoip: true
    preserve_sources_list: false
    primary:
     - arches: [amd64, i386]
       uri: http://archive.ubuntu.com/ubuntu
     - arches: [default]
       uri: http://ports.ubuntu.com/ubuntu-ports
    # Repos for extra packages must go into sources. 
    # sources: 

  ssh:
    install-server: true
    allow-pw: false
  
  keyboard: 
    layout: us
    toggle: null
    variant: ''

  locale: C

  network:
    version: 2
    ethernets:
      maineth:
        match:
          name: "en*"
        dhcp4: true
  
  disk_setup:
    /dev/sda: 
      table_type: gpt
      layout: 
        - 0.5
        - 1
        - 98.5
      overwrite: true
      # grub_device: false
      type: disk

  fs_setup:
    - device: /dev/sda1
      filesystem: fat32
      label: EFI
      overwrite: false
      type: format
    - device: /dev/sda2
      filesystem: ext4
      label: BOOT
      overwrite: false
      type: format
    - device: /dev/sda3
      filesystem: ext4
      label: ROOT
      overwrite: false
      type: format

  user-data:
    timezone: Europe/Zurich

    # The hostname should be set via DHCP.
    hostname: multimico
        
    users: 
      - name: multimico
        passwd: "$6$rounds=4096$88d20636d3$hfs3chRNQ5UEDtzXysdkx.NhtTCN8kpefW3.tWCFuKR5Bg6tJ7wbUhA2CwyUtWeRy7l4LeY0qmNyJm73CAlkP1"
        lock_passwd: false

        ssh_import_id: 
          - gh:phish108
          - gh:grahanoi

        shell: /bin/bash

        groups:
          - sudo
          - adm
          - plugdev
          - cdrom

    ssh_pwauth: false
    
    chpasswd: 
      - name: multimico
        expire: False
        lock_passwd: False
        password: "$6$rounds=4096$88d20636d3$hfs3chRNQ5UEDtzXysdkx.NhtTCN8kpefW3.tWCFuKR5Bg6tJ7wbUhA2CwyUtWeRy7l4LeY0qmNyJm73CAlkP1"

    package_update: true
    package_upgrade: true
    package_reboot_if_required: true
    packages:
      - petname
      - openvswitch-switch-dpdk
      - libosinfo-bin
      - whois
  
    # the following commands run after all package updates and installs
    runcmd:
      # bootstrap the machine specific installation
      #
      # install incus
      - mkdir -p /etc/apt/keyrings/
      - curl -fsSL https://pkgs.zabbly.com/key.asc -o /etc/apt/keyrings/zabbly.asc
      - |
        sh -c 'cat <<EOF > /etc/apt/sources.list.d/zabbly-incus-stable.sources
        Enabled: yes
        Types: deb
        URIs: https://pkgs.zabbly.com/incus/stable
        Suites: $(. /etc/os-release && echo ${VERSION_CODENAME})
        Components: main
        Architectures: $(dpkg --print-architecture)
        Signed-By: /etc/apt/keyrings/zabbly.asc
        EOF'
      - apt update
      - apt install -y incus-base incus-extra

      # add the incus-admin user
      - adduser multimico incus-admin

      # install our internal maintenance tools from github

      # first layer of defense - ufw 
      
      # finally, disable cloud-init
      #
      # This MUST NOT be created via write_files as this would create the file before 
      # the first reboot. This would cause cloud-init not to run for the first time. So we
      # disable cloud-init once everything has finished. 
      - touch /etc/cloud/cloud-init.disabled
